{% extends "layout.html" %}

{% block title %}
    My Debts
{% endblock %}

{% block content %}
    <h1>My Debts</h1>
    <div class="debt-container">
        <div class="debt-section">
            <h2>Money I Owe</h2>
            <div class="debt-list">
                {% for debt in debts %}
                    {% if debt.debtor == request.user.username %}
                        <div class="debt-item owe">
                            <p>You owe <strong>{{ debt.creditor }}</strong> ${{ debt.amount }}</p>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="debt-section">
            <h2>Money Owed to Me</h2>
            <div class="debt-list">
                {% for debt in debts %}
                    {% if debt.creditor == request.user.username %}
                        <div class="debt-item owed" id="debt-{{ forloop.counter }}">
                            <p><strong>{{ debt.debtor }}</strong> owes you ${{ debt.amount }}</p>
                            <button class="cancel-debt-button" 
                                    onclick="confirmCancelDebt('{{ debt.debtor }}', '{{ debt.amount }}', '{{ csrf_token }}')">
                                Cancel Debt
                            </button>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="debt-section">
            <h2>Net Balance</h2>
            <div class="debt-total">
                {% for balance in total_balance %}
                    {% if balance.user == request.user.username %}
                        <p class="{% if balance.net_balance < 0 %}negative{% else %}positive{% endif %}">
                            {% if balance.net_balance < 0 %}
                                You owe a total of ${{ balance.net_balance|cut:"-" }}
                            {% else %}
                                You are owed a total of ${{ balance.net_balance }}
                            {% endif %}
                        </p>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        async function confirmCancelDebt(debtor, amount, csrfToken) {
            if (confirm(`Are you sure you want to cancel the debt of $${amount} from ${debtor}?`)) {
                try {
                    const response = await fetch('/transaction/cancel_debt/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            debtor: debtor,
                            amount: amount
                        })
                    });

                    if (response.ok) {
                        // Refresh the debt data
                        await updateDebtView();
                    } else {
                        alert('Failed to cancel debt. Please try again.');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while canceling the debt.');
                }
            }
        }

        async function updateDebtView() {
            try {
                // Fetch updated debt relationships
                const debtResponse = await fetch('/api/debts/');
                const debts = await debtResponse.json();

                // Fetch updated total balance
                const totalResponse = await fetch('/api/debts/total/');
                const totalBalance = await totalResponse.json();

                // Update the UI
                updateDebtUI(debts, totalBalance);
            } catch (error) {
                console.error('Error updating debt view:', error);
            }
        }

        function updateDebtUI(debts, totalBalance) {
            // Update Money I Owe section
            const oweList = document.querySelector('.debt-section:nth-child(1) .debt-list');
            oweList.innerHTML = debts
                .filter(debt => debt.debtor === '{{ request.user.username }}')
                .map(debt => `
                    <div class="debt-item owe">
                        <p>You owe <strong>${debt.creditor}</strong> $${debt.amount}</p>
                    </div>
                `).join('');

            // Update Money Owed to Me section
            const owedList = document.querySelector('.debt-section:nth-child(2) .debt-list');
            owedList.innerHTML = debts
                .filter(debt => debt.creditor === '{{ request.user.username }}')
                .map((debt, index) => `
                    <div class="debt-item owed" id="debt-${index + 1}">
                        <p><strong>${debt.debtor}</strong> owes you $${debt.amount}</p>
                        <button class="cancel-debt-button" 
                                onclick="confirmCancelDebt('${debt.debtor}', '${debt.amount}', '{{ csrf_token }}')">
                            Cancel Debt
                        </button>
                    </div>
                `).join('');

            // Update Net Balance section
            const totalSection = document.querySelector('.debt-total');
            const userBalance = totalBalance.find(balance => balance.user === '{{ request.user.username }}');
            if (userBalance) {
                const netBalance = parseFloat(userBalance.net_balance);
                totalSection.innerHTML = `
                    <p class="${netBalance < 0 ? 'negative' : 'positive'}">
                        ${netBalance < 0 
                            ? `You owe a total of $${Math.abs(netBalance).toFixed(2)}`
                            : `You are owed a total of $${netBalance.toFixed(2)}`}
                    </p>
                `;
            }
        }
    </script>
{% endblock %} 